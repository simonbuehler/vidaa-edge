<div
  class="max-w-6xl mx-auto p-5 bg-customGray text-gray-200 min-h-screen font-sans"
>
  <header class="text-center mb-4">
    <h1 class="text-orange-500 text-3xl font-bold mb-1">
      üíª Remote Function Controller
    </h1>
    <!-- Only show connection status when functions are available (not during initial setup) -->
    <div class="flex justify-center" *ngIf="availableFunctions.length > 0">
      <div
        class="flex items-center gap-3 bg-customGray-light px-4 py-2 rounded-lg border border-purple-900"
        [class.bg-green-900]="tvConnection.connected"
        [class.bg-red-900]="!tvConnection.connected"
      >
        <div
          class="w-3 h-3 rounded-full"
          [class.bg-green-400]="tvConnection.connected"
          [class.bg-red-400]="!tvConnection.connected"
        ></div>
        <div class="text-sm">
          <span class="font-medium">
            {{ getDeviceBrand() }} TV ({{ getDeviceModel() }})
            {{ tvConnection.connected ? 'Connected' : 'Disconnected' }} ‚Ä¢ FW
            {{ getDeviceFirmware() }} ‚Ä¢ Last seen
            {{ formatTime(tvConnection.lastSeen) }}
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Waiting for TV Instructions -->
  <div
    class="max-w-4xl mx-auto"
    *ngIf="availableFunctions.length === 0 && !tvConnection.connected"
  >
    <div
      class="bg-customGray-light rounded-lg p-8 shadow-lg border border-purple-900"
    >
      <h2 class="text-2xl font-bold text-orange-500 mb-4">
        üì∫ TV Setup Required
      </h2>
      <p class="text-gray-300 mb-8">
        To use the Remote Console, please follow these steps on your TV:
      </p>

      <div class="space-y-6">
        <div class="flex items-start gap-4">
          <span
            class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0"
            >1</span
          >
          <div>
            <h4 class="text-lg font-semibold text-white mb-2">
              Open TV Browser
            </h4>
            <p class="text-gray-300">
              Navigate to the browser app on your Hisense/VIDAA TV
            </p>
          </div>
        </div>

        <div class="flex items-start gap-4">
          <span
            class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0"
            >2</span
          >
          <div>
            <h4 class="text-lg font-semibold text-white mb-2">
              Visit Development Console
            </h4>
            <p class="text-gray-300 mb-2">Go to:</p>
            <code
              class="bg-customGray text-orange-400 px-3 py-1 rounded block border border-purple-900"
              >https://vidaahub.com/console</code
            >
            <p class="text-gray-400 text-sm mt-1">
              DNS must redirect vidaahub.com to your local dev server
            </p>
          </div>
        </div>

        <div class="flex items-start gap-4">
          <span
            class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0"
            >3</span
          >
          <div>
            <h4 class="text-lg font-semibold text-white mb-2">
              Auto-Scan Functions
            </h4>
            <p class="text-gray-300">
              The TV will automatically scan and upload available functions
            </p>
          </div>
        </div>
      </div>

      <div
        class="mt-8 p-5 bg-customGray rounded-lg border-l-4 border-orange-500"
      >
        <div class="flex items-center justify-center gap-3 mb-3">
          <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
          <span class="text-orange-400 font-bold"
            >Waiting for TV connection...</span
          >
        </div>
        <p class="text-gray-400 text-sm text-center italic">
          This page automatically updates when TV functions are detected.
        </p>
      </div>
    </div>
  </div>

  <!-- Function Library Browser (only when functions are available) -->
  <div
    class="bg-customGray-light rounded-lg p-6 mb-6 border border-purple-900"
    *ngIf="availableFunctions.length > 0"
  >
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-orange-500">üìö Function Library</h2>
      <div class="flex gap-3">
        <input
          type="text"
          [(ngModel)]="functionFilter"
          (input)="filterFunctions()"
          placeholder="üîç Search functions..."
          class="bg-customGray text-white px-4 py-2 rounded-lg border border-purple-900 focus:border-orange-500 focus:outline-none"
          aria-label="Search functions"
        />
        <button
          (click)="saveFunctionsToDisk()"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"
          aria-label="Save functions to disk"
          [disabled]="availableFunctions.length === 0"
        >
          üíæ Save to Disk
        </button>
        <button
          (click)="openCustomCodeModal()"
          class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"
          aria-label="Open custom code editor"
        >
          üìù Custom Code
        </button>
      </div>
    </div>

    <!-- Horizontal Categories -->
    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
      <button
        *ngFor="let category of categories"
        class="px-4 py-2 rounded-lg transition-colors whitespace-nowrap text-sm"
        [class.bg-orange-600]="selectedCategory === category.key"
        [class.text-white]="selectedCategory === category.key"
        [class.bg-customGray]="selectedCategory !== category.key"
        [class.text-gray-300]="selectedCategory !== category.key"
        [class.hover:bg-orange-500]="selectedCategory !== category.key"
        (click)="selectCategory(category.key)"
      >
        {{ category.icon }} {{ category.name }} ({{
          getCategoryCount(category.key)
        }})
      </button>
    </div>

    <!-- Compact Function Grid - SMALLER! -->
    <div
      class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 max-h-48 overflow-y-auto p-1"
    >
      <div
        *ngFor="let func of filteredFunctions"
        [ngClass]="{
          'bg-customGray rounded-lg p-2 cursor-pointer transition-all hover:bg-purple-900/30 relative border border-purple-900': true,
          'ring-2 ring-orange-500 ring-offset-2 ring-offset-customGray-light bg-orange-900/30':
            selectedFunction?.name === func.name
        }"
        (click)="selectFunction(func)"
        tabindex="0"
        role="button"
        (keyup.enter)="selectFunction(func)"
        (keyup.space)="selectFunction(func)"
      >
        <div class="flex items-center justify-between">
          <span class="text-white text-xs font-medium truncate">{{
            func.name
          }}</span>
          <div class="flex items-center gap-1">
            <button
              (click)="copyFunctionToCustomCode(func); $event.stopPropagation()"
              class="text-xs text-orange-400 hover:text-orange-300 transition-colors"
              title="Copy to Custom Code"
            >
              üìã
            </button>
            <span
              class="text-xs bg-purple-900 text-gray-300 px-1 py-0.5 rounded flex-shrink-0"
              >{{ getFunctionType(func.name) }}</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Function Execution Modal -->
  <app-code-modal
    [isOpen]="showExecutionModal"
    [title]="'Execute Function: ' + (selectedFunction?.name || '')"
    [showExecuteButton]="true"
    (closeModal)="closeExecutionModal()"
    (executeCode)="executeFunction()"
  >
    <div class="space-y-4" *ngIf="selectedFunction">
      <!-- Source Code Display -->
      <div *ngIf="selectedFunction.sourceCode">
        <div class="block text-sm font-semibold text-gray-300 mb-2">
          Source Code:
        </div>
        <pre
          class="bg-customGray p-3 rounded border border-purple-900 font-mono text-xs overflow-x-auto max-h-32 text-gray-300"
          >{{ selectedFunction.sourceCode }}</pre
        >
      </div>

      <!-- Parameters -->
      <div
        *ngIf="
          selectedFunction.parameters && selectedFunction.parameters.length > 0
        "
      >
        <div class="block text-sm font-semibold text-gray-300 mb-2">
          Parameters:
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div *ngFor="let param of selectedFunction.parameters; let i = index">
            <label
              [for]="'modal-param-' + i"
              class="block mb-1 text-sm text-gray-400"
              >{{ param }}</label
            >
            <input
              [id]="'modal-param-' + i"
              type="text"
              [(ngModel)]="parameterValues[i]"
              class="w-full p-2 bg-customGray border border-purple-900 rounded text-gray-200 text-sm focus:outline-none focus:border-orange-500"
              [placeholder]="getParameterHint(param)"
            />
          </div>
        </div>
      </div>

      <!-- No Parameters Message -->
      <div
        *ngIf="
          !selectedFunction.parameters ||
          selectedFunction.parameters.length === 0
        "
        class="text-gray-400 text-sm italic"
      >
        This function takes no parameters.
      </div>

      <!-- Result Display -->
      <div *ngIf="executionResult !== null" class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-orange-400">üìä Result:</div>
          <button
            (click)="copyResultToClipboard()"
            class="text-xs text-gray-400 hover:text-orange-400 transition-colors px-2 py-1 rounded hover:bg-purple-900/30"
            title="Copy to clipboard"
          >
            üìã Copy
          </button>
        </div>
        <pre
          class="bg-customGray p-3 rounded border border-purple-900 font-mono text-xs max-h-48 overflow-y-auto text-gray-300"
          >{{ formatResult(executionResult) }}</pre
        >
      </div>

      <!-- Executing Indicator -->
      <div *ngIf="isExecuting" class="text-center text-orange-400">
        ‚è≥ Executing function on TV...
      </div>
    </div>
  </app-code-modal>

  <!-- Command History -->
  <div
    class="bg-customGray-light rounded-lg p-6 mt-6 border border-purple-900"
    *ngIf="commandHistory.length > 0"
  >
    <h3 class="text-xl font-bold text-orange-500 mb-4">üìú Command History</h3>
    <div class="space-y-3">
      <div
        *ngFor="let command of commandHistory.slice().reverse(); let i = index"
        class="bg-customGray rounded border border-purple-900 p-3"
      >
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1 min-w-0">
            <div class="flex items-baseline gap-2 flex-wrap">
              <span class="font-mono font-bold text-orange-400 text-sm">{{
                command.functionName
              }}</span>
              <!-- Show Parameters for regular functions - max 25% width -->
              <span
                *ngIf="
                  command.parameters &&
                  command.parameters.length > 0 &&
                  !command.customCode
                "
                class="text-gray-400 text-xs truncate max-w-[25%]"
                [title]="'(' + command.parameters.join(', ') + ')'"
                >({{ command.parameters.join(', ') }})</span
              >
              <!-- Expandable Custom Code -->
              <button
                *ngIf="command.customCode"
                (click)="toggleHistoryExpansion(commandHistory.length - 1 - i)"
                class="text-xs text-gray-400 hover:text-orange-400 transition-colors"
                title="Show/Hide Code"
              >
                {{
                  isHistoryExpanded(commandHistory.length - 1 - i) ? '‚ñº' : '‚ñ∂'
                }}
                Show Code
              </button>
            </div>
          </div>
          <div class="flex items-center gap-3 ml-4 flex-shrink-0">
            <span class="text-gray-400 text-xs">{{
              formatTime(command.timestamp)
            }}</span>
            <span
              class="text-sm font-bold"
              [class.text-green-400]="command.success"
              [class.text-red-400]="!command.success"
            >
              {{ command.success ? '‚úÖ' : '‚ùå' }}
            </span>
          </div>
        </div>

        <!-- Custom Code Display (Expandable) -->
        <div
          *ngIf="
            command.customCode &&
            isHistoryExpanded(commandHistory.length - 1 - i)
          "
          class="mb-2"
        >
          <pre
            class="bg-customGray p-3 rounded border border-purple-900 font-mono text-xs overflow-x-auto max-h-32 text-gray-300"
            >{{ command.customCode }}</pre
          >
        </div>

        <!-- Show Result -->
        <div *ngIf="command.result !== undefined && command.result !== null">
          <pre
            class="bg-customGray p-2 rounded border border-purple-900 text-xs font-mono text-gray-300 max-h-20 overflow-y-auto"
            >{{ formatResult(command.result) }}</pre
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Code Modal -->
  <app-code-modal
    [isOpen]="showCustomCodeModal"
    [title]="'Custom JavaScript Code'"
    [showExecuteButton]="true"
    (closeModal)="closeCustomCodeModal()"
    (executeCode)="executeCustomCode()"
  >
    <div class="space-y-4">
      <div>
        <div class="block text-sm font-semibold text-gray-300 mb-2">
          JavaScript Code:
        </div>
        <textarea
          [(ngModel)]="customJsCode"
          class="w-full h-64 p-3 bg-customGray border border-purple-900 rounded text-gray-200 font-mono text-sm focus:outline-none focus:border-orange-500"
          placeholder="// Enter custom JavaScript code to execute on TV...&#10;// Example:&#10;const result = Hisense_GetBrand();&#10;console.log(result);&#10;return result;"
        ></textarea>
      </div>

      <div *ngIf="customCodeResult !== null" class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-orange-400">üìä Result:</div>
          <button
            (click)="copyCustomCodeResultToClipboard()"
            class="text-xs text-gray-400 hover:text-orange-400 transition-colors px-2 py-1 rounded hover:bg-purple-900/30"
            title="Copy to clipboard"
          >
            üìã Copy
          </button>
        </div>
        <pre
          class="bg-customGray p-3 rounded border border-purple-900 font-mono text-xs max-h-48 overflow-y-auto text-gray-300"
          >{{ formatResult(customCodeResult) }}</pre
        >
      </div>

      <div *ngIf="isExecutingCustomCode" class="text-center text-orange-400">
        ‚è≥ Executing custom code on TV...
      </div>
    </div>
  </app-code-modal>
</div>

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VIDAA TV Remote Console</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: #fff;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .status {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dc3545;
        display: inline-block;
        margin-right: 8px;
      }

      .status-dot.connected {
        background: #28a745;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .panel h2 {
        margin-bottom: 15px;
        color: #fff;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 8px;
      }

      .function-selector {
        margin-bottom: 15px;
      }

      .function-selector select {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.9);
        font-size: 14px;
      }

      .params-container {
        margin-bottom: 15px;
      }

      .param-group {
        margin-bottom: 10px;
      }

      .param-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .param-group input {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
      }

      .execute-btn {
        width: 100%;
        padding: 12px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background 0.3s ease;
      }

      .execute-btn:hover {
        background: #45a049;
      }

      .execute-btn:disabled {
        background: #666;
        cursor: not-allowed;
      }

      .quick-commands {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .quick-cmd {
        padding: 8px 12px;
        background: #ff9800;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s ease;
      }

      .quick-cmd:hover {
        background: #f57c00;
      }

      .console-output {
        background: #000;
        color: #00ff00;
        padding: 15px;
        border-radius: 6px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 15px;
      }

      .console-output .timestamp {
        color: #888;
      }

      .console-output .error {
        color: #ff4444;
      }

      .console-output .success {
        color: #44ff44;
      }

      .console-output .info {
        color: #4488ff;
      }

      .clear-btn {
        padding: 8px 16px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üñ•Ô∏è VIDAA TV Remote Console</h1>
        <p>Steuere deinen Hisense VIDAA TV bequem vom Laptop aus</p>
      </div>

      <div class="status">
        <div>
          <span class="status-dot" id="connectionStatus"></span>
          <span id="statusText">Verbindung pr√ºfen...</span>
        </div>
        <div id="tvInfo">TV Info wird geladen...</div>
      </div>

      <div class="main-content">
        <!-- Function Explorer Panel -->
        <div class="panel">
          <h2>üîß Function Explorer</h2>

          <div class="function-selector">
            <select id="functionSelect">
              <option value="">Funktion ausw√§hlen...</option>
            </select>
          </div>

          <div class="params-container" id="paramsContainer">
            <p style="color: #ccc; font-style: italic">
              W√§hle eine Funktion aus
            </p>
          </div>

          <button class="execute-btn" id="executeBtn" disabled>
            üöÄ Funktion ausf√ºhren
          </button>

          <div style="margin-top: 15px">
            <h3 style="margin-bottom: 10px">‚ö° Quick Commands</h3>
            <div class="quick-commands">
              <button
                class="quick-cmd"
                onclick="executeQuick('Hisense_GetDeviceInfo')"
              >
                üì± Device Info
              </button>
              <button
                class="quick-cmd"
                onclick="executeQuick('Hisense_GetApiVersion')"
              >
                üî¢ API Version
              </button>
              <button
                class="quick-cmd"
                onclick="executeQuick('Hisense_GetNetStatus')"
              >
                üåê Netzwerk Status
              </button>
              <button
                class="quick-cmd"
                onclick="executeQuick('Hisense_GetVolume')"
              >
                üîä Lautst√§rke
              </button>
              <button
                class="quick-cmd"
                onclick="executeQuick('Hisense_GetCurrentBrowser')"
              >
                üåç Browser Info
              </button>
              <button
                class="quick-cmd"
                onclick="executeQuick('Hisense_GetMacAddress')"
              >
                üè∑Ô∏è MAC Address
              </button>
            </div>
          </div>
        </div>

        <!-- Console Output Panel -->
        <div class="panel">
          <h2>üìü Console Output</h2>

          <div class="console-output" id="consoleOutput">
            <div class="timestamp">[${new Date().toLocaleTimeString()}]</div>
            <div class="info">VIDAA Remote Console gestartet</div>
            <div class="info">Warte auf Verbindung zum TV...</div>
          </div>

          <button class="clear-btn" onclick="clearConsole()">
            üóëÔ∏è Console leeren
          </button>

          <div style="margin-top: 15px">
            <h3 style="margin-bottom: 10px">üìÅ File Explorer</h3>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="filePath"
                placeholder="Dateipfad (z.B. /etc/passwd)"
                style="flex: 1; padding: 8px; border: none; border-radius: 4px"
              />
              <button class="quick-cmd" onclick="readFile()" style="margin: 0">
                üìñ Lesen
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuration - Use local DNS
      function getReceiverURL() {
        // Try to get custom hostname from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const customHost = urlParams.get('host');
        if (customHost) {
          return `http://${customHost}:3000`;
        }

        // Check if we're on the custom domain
        if (
          window.location.hostname === 'vidaahub.com' ||
          window.location.hostname.endsWith('.vidaahub.com')
        ) {
          return 'http://vidaahub.com:3000';
        }

        // If accessed from localhost (laptop), use localhost
        if (
          window.location.hostname === 'localhost' ||
          window.location.hostname === '127.0.0.1'
        ) {
          return 'http://localhost:3000';
        }

        // Fallback: use the current hostname
        return `http://${window.location.hostname}:3000`;
      }

      const RECEIVER_URL = getReceiverURL();
      let isConnected = false;
      let availableFunctions = [];

      // DOM Elements
      const connectionStatus = document.getElementById('connectionStatus');
      const statusText = document.getElementById('statusText');
      const tvInfo = document.getElementById('tvInfo');
      const functionSelect = document.getElementById('functionSelect');
      const paramsContainer = document.getElementById('paramsContainer');
      const executeBtn = document.getElementById('executeBtn');
      const consoleOutput = document.getElementById('consoleOutput');

      // Initialize
      document.addEventListener('DOMContentLoaded', function () {
        checkConnection();
        loadFunctions();

        // Function selection handler
        functionSelect.addEventListener('change', function () {
          const selectedFunction = this.value;
          if (selectedFunction) {
            loadFunctionParams(selectedFunction);
            executeBtn.disabled = false;
          } else {
            paramsContainer.innerHTML =
              '<p style="color: #ccc; font-style: italic;">W√§hle eine Funktion aus</p>';
            executeBtn.disabled = true;
          }
        });

        // Execute button handler
        executeBtn.addEventListener('click', function () {
          const selectedFunction = functionSelect.value;
          if (selectedFunction) {
            executeFunction(selectedFunction);
          }
        });
      });

      // Check connection to receiver
      async function checkConnection() {
        try {
          const response = await fetch(`${RECEIVER_URL}/api/status`);
          const data = await response.json();

          if (data.status === 'ok') {
            isConnected = true;
            connectionStatus.classList.add('connected');
            statusText.textContent = 'Verbunden mit Receiver';

            if (data.tvConnected) {
              tvInfo.textContent = `TV: ${data.tvInfo?.brand || 'Unknown'} - ${
                data.tvInfo?.model || 'Unknown'
              }`;
            } else {
              tvInfo.textContent = 'TV nicht verbunden';
            }
          }
        } catch (error) {
          isConnected = false;
          connectionStatus.classList.remove('connected');
          statusText.textContent = 'Keine Verbindung zum Receiver';
          tvInfo.textContent = 'Server pr√ºfen';
          logToConsole('error', `Verbindungsfehler: ${error.message}`);
        }
      }

      // Load available functions
      async function loadFunctions() {
        try {
          // Load from local source files
          const functions = [
            'Hisense_GetDeviceInfo',
            'Hisense_GetApiVersion',
            'Hisense_GetNetStatus',
            'Hisense_GetVolume',
            'Hisense_GetMute',
            'Hisense_GetCurrentBrowser',
            'Hisense_GetMacAddress',
            'Hisense_GetIPAddress',
            'Hisense_GetModelName',
            'Hisense_FileRead',
            'Hisense_FileWrite',
            'Hisense_GetDNS',
            'Hisense_SetDNS',
            'Hisense_EnableDebugLog',
            'Hisense_getDebugPort',
            'Hisense_setDebugPort',
            'Hisense_GetDeviceID',
            'Hisense_GetUuid',
            'Hisense_GetBrand',
            'Hisense_GetCountryCode',
            'Hisense_GetFirmWareVersion',
            'Hisense_GetOSVersion',
          ];

          functionSelect.innerHTML =
            '<option value="">Funktion ausw√§hlen...</option>';
          functions.forEach((func) => {
            const option = document.createElement('option');
            option.value = func;
            option.textContent = func;
            functionSelect.appendChild(option);
          });

          availableFunctions = functions;
          logToConsole('success', `${functions.length} Funktionen geladen`);
        } catch (error) {
          logToConsole(
            'error',
            `Fehler beim Laden der Funktionen: ${error.message}`
          );
        }
      }

      // Load function parameters
      function loadFunctionParams(functionName) {
        const paramDefinitions = {
          Hisense_FileRead: [
            {
              name: 'path',
              type: 'text',
              placeholder: 'Dateipfad (z.B. /etc/passwd)',
              required: true,
            },
            {
              name: 'mode',
              type: 'number',
              placeholder: 'Modus (0-6)',
              value: '0',
              required: true,
            },
          ],
          Hisense_FileWrite: [
            {
              name: 'path',
              type: 'text',
              placeholder: 'Dateipfad',
              required: true,
            },
            {
              name: 'writedata',
              type: 'text',
              placeholder: 'Daten zum Schreiben',
              required: true,
            },
            {
              name: 'mode',
              type: 'number',
              placeholder: 'Modus',
              value: '0',
              required: true,
            },
          ],
          Hisense_SetDNS: [
            {
              name: 'dns',
              type: 'text',
              placeholder: 'DNS Server (z.B. 8.8.8.8)',
              required: true,
            },
            {
              name: 'code',
              type: 'text',
              placeholder: 'Code (optional)',
              required: false,
            },
          ],
          Hisense_EnableDebugLog: [
            {
              name: 'module',
              type: 'text',
              placeholder: 'Modul Name',
              required: true,
            },
          ],
          Hisense_setDebugPort: [
            {
              name: 'type',
              type: 'text',
              placeholder: 'Port Typ',
              required: true,
            },
            {
              name: 'code',
              type: 'text',
              placeholder: 'Access Code',
              required: false,
            },
          ],
          Hisense_GetDeviceID: [
            {
              name: 'num',
              type: 'number',
              placeholder: 'L√§nge (32 oder leer)',
              required: false,
            },
          ],
        };

        const params = paramDefinitions[functionName] || [];

        if (params.length === 0) {
          paramsContainer.innerHTML =
            '<p style="color: #90EE90;">Keine Parameter erforderlich</p>';
          return;
        }

        let html = '';
        params.forEach((param) => {
          html += `
                    <div class="param-group">
                        <label>${param.name}${
            param.required ? ' *' : ''
          }:</label>
                        <input type="${param.type}" 
                               name="${param.name}" 
                               placeholder="${param.placeholder}"
                               value="${param.value || ''}"
                               ${param.required ? 'required' : ''}>
                    </div>
                `;
        });

        paramsContainer.innerHTML = html;
      }

      // Execute function
      async function executeFunction(functionName) {
        const params = [];
        const inputs = paramsContainer.querySelectorAll('input');

        inputs.forEach((input) => {
          if (input.value.trim() !== '') {
            params.push(input.value.trim());
          } else if (input.required) {
            logToConsole('error', `Parameter "${input.name}" ist erforderlich`);
            return;
          }
        });

        logToConsole(
          'info',
          `Ausf√ºhrung: ${functionName}(${params.join(', ')})`
        );

        try {
          const response = await fetch(`${RECEIVER_URL}/api/remote-command`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              function: functionName,
              parameters: params,
            }),
          });

          // Debug: Log raw response to see what server actually sends
          const responseText = await response.text();
          console.log('Raw server response:', responseText);
          logToConsole(
            'debug',
            `Raw Response: ${responseText.substring(0, 200)}...`
          );

          const result = JSON.parse(responseText);

          if (result.success) {
            logToConsole(
              'success',
              `Ergebnis: ${JSON.stringify(result.data, null, 2)}`
            );
          } else {
            logToConsole('error', `Fehler: ${result.error}`);
          }
        } catch (error) {
          logToConsole('error', `Ausf√ºhrungsfehler: ${error.message}`);
        }
      }

      // Execute quick command
      async function executeQuick(functionName) {
        functionSelect.value = functionName;
        loadFunctionParams(functionName);
        executeBtn.disabled = false;
        await executeFunction(functionName);
      }

      // Read file helper
      async function readFile() {
        const filePath = document.getElementById('filePath').value.trim();
        if (!filePath) {
          logToConsole('error', 'Bitte Dateipfad eingeben');
          return;
        }

        logToConsole('info', `Datei lesen: ${filePath}`);

        try {
          const response = await fetch(`${RECEIVER_URL}/api/remote-command`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              function: 'Hisense_FileRead',
              parameters: [filePath, '0'],
            }),
          });

          const result = await response.json();

          if (result.success) {
            logToConsole('success', `Dateiinhalt:\n${result.data}`);
          } else {
            logToConsole('error', `Fehler beim Lesen: ${result.error}`);
          }
        } catch (error) {
          logToConsole('error', `Lesefehler: ${error.message}`);
        }
      }

      // Console logging
      function logToConsole(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');

        logEntry.innerHTML = `
                <div class="timestamp">[${timestamp}]</div>
                <div class="${type}">${message}</div>
            `;

        consoleOutput.appendChild(logEntry);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
      }

      // Clear console
      function clearConsole() {
        consoleOutput.innerHTML = `
                <div class="timestamp">[${new Date().toLocaleTimeString()}]</div>
                <div class="info">Console geleert</div>
            `;
      }

      // Auto-reconnect
      setInterval(checkConnection, 10000); // Check every 10 seconds
    </script>
  </body>
</html>
